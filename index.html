<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTC 关机币价计算器</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>₿</text></svg>">
  <style>
    :root {
      --bg: #1a1a2e;
      --card: #16213e;
      --border: #0f3460;
      --text: #eaeaea;
      --dim: #8a8a8a;
      --gold: #f7931a;
      --green: #4cd964;
      --red: #e74c5f;
      --blue: #4da6ff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; padding: 16px;
    }
    .container { max-width: 960px; margin: 0 auto; }

    .stats-bar {
      display: flex; flex-wrap: wrap; gap: 12px;
      margin-bottom: 16px; padding: 14px 18px;
      background: var(--card); border-radius: 10px; border: 1px solid var(--border);
    }
    .stat-item { flex: 1; min-width: 110px; }
    .stat-label { font-size: 11px; color: var(--dim); margin-bottom: 2px; }
    .stat-value { font-size: 20px; font-weight: 700; }
    .stat-value.price { color: var(--gold); }
    .stat-value.hashrate { color: var(--blue); }
    .stat-value.range { font-size: 14px; }
    .stat-value .profit { color: var(--green); }

    .elec-control {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 18px; background: var(--card);
      border-radius: 10px; border: 1px solid var(--border); margin-bottom: 16px;
    }
    .elec-label { font-size: 12px; color: var(--dim); }
    .elec-slider {
      flex: 1; max-width: 260px; height: 5px;
      -webkit-appearance: none;
      background: linear-gradient(90deg, var(--green), var(--gold), var(--red));
      border-radius: 3px; outline: none;
    }
    .elec-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px;
      background: white; border-radius: 50%; cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    .elec-value { font-size: 15px; font-weight: 600; color: var(--gold); min-width: 85px; }

    .percentiles {
      display: flex; margin-bottom: 14px;
      background: var(--card); border-radius: 10px; border: 1px solid var(--border); overflow: hidden;
    }
    .pct-item { flex: 1; padding: 10px 14px; border-right: 1px solid var(--border); }
    .pct-item:last-child { border-right: none; }
    .pct-item.active { background: rgba(247,147,26,0.1); border: 2px solid var(--gold); border-radius: 6px; }
    .pct-label { font-size: 12px; color: var(--dim); }
    .pct-value { font-size: 18px; font-weight: 700; margin-top: 1px; }
    .pct-item.active .pct-value { color: var(--gold); }

    .chart-section {
      background: var(--card); border-radius: 10px;
      border: 1px solid var(--border); padding: 16px; margin-bottom: 16px;
    }
    .chart-title { font-size: 13px; color: var(--dim); margin-bottom: 10px; }

    /* 图表布局: 左侧标签 + 右侧条形区域 */
    .chart-row { display: flex; align-items: center; height: 18px; margin-bottom: 1px; }
    .chart-label {
      width: 140px; flex-shrink: 0; font-size: 11px; color: var(--dim);
      text-align: right; padding-right: 8px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    /* 右侧条形区域：所有条形和价格线共享这个容器 */
    .tracks-area {
      position: relative;
      flex: 1;
    }
    .track-bar {
      height: 14px; margin-bottom: 1px;
      border-radius: 0 2px 2px 0;
      min-width: 2px;
    }
    .track-bar.profit { background: var(--green); }
    .track-bar.loss { background: var(--red); }

    /* 价格竖线 — 在 tracks-area 内，直接用百分比 */
    .price-line-v {
      position: absolute; top: 0; bottom: 0; width: 2px;
      background: var(--gold); z-index: 10; pointer-events: none;
    }
    .price-line-tag {
      position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
      font-size: 11px; font-weight: 600; color: var(--gold); white-space: nowrap;
    }

    /* X 轴 */
    .x-axis-row { display: flex; align-items: center; margin-top: 6px; }
    .x-axis-spacer { width: 140px; flex-shrink: 0; }
    .x-axis-track {
      flex: 1; display: flex; justify-content: space-between;
      font-size: 10px; color: var(--dim);
      border-top: 1px solid var(--border); padding-top: 4px;
    }

    .table-section {
      background: var(--card); border-radius: 10px;
      border: 1px solid var(--border); overflow: hidden;
    }
    .table-title { font-size: 14px; font-weight: 600; padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .miner-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .miner-table th {
      text-align: left; padding: 8px 12px; color: var(--dim);
      font-weight: 500; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2);
    }
    .miner-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
    .miner-table tr:hover { background: rgba(255,255,255,0.02); }
    .miner-table .model { font-weight: 500; }
    .miner-table .shutdown { font-weight: 600; }
    .miner-table .shutdown.profit { color: var(--green); }
    .miner-table .shutdown.loss { color: var(--red); }
    .status-badge {
      display: inline-block; padding: 2px 8px;
      border-radius: 10px; font-size: 10px; font-weight: 500;
    }
    .status-profit { background: rgba(76,217,100,0.15); color: var(--green); }
    .status-loss { background: rgba(231,76,95,0.15); color: var(--red); }

    .footer { text-align: center; padding: 14px; font-size: 11px; color: var(--dim); }
    .footer a { color: var(--blue); text-decoration: none; }

    @media (max-width: 600px) {
      .stat-value { font-size: 15px; }
      .pct-value { font-size: 14px; }
      .chart-label { width: 100px; font-size: 9px; }
      .x-axis-spacer { width: 100px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-label">BTC 价格</div>
        <div class="stat-value price" id="btc-price">$--,---</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">电费</div>
        <div class="stat-value" id="elec-display" style="color:var(--gold)">$0.060</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">全网算力</div>
        <div class="stat-value hashrate" id="hashrate">--- EH/s</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">关机价范围</div>
        <div class="stat-value range" id="range">--- ~ ---</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">盈利矿机</div>
        <div class="stat-value" id="profit-count"><span class="profit">--</span>/--</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">ahr999 定投指数</div>
        <div class="stat-value" id="ahr999" style="color:var(--green)">--</div>
      </div>
    </div>

    <div class="elec-control">
      <span class="elec-label">电费:</span>
      <input type="range" class="elec-slider" id="electricity" min="0.02" max="0.15" step="0.005" value="0.06">
      <span class="elec-value" id="elec-value">$0.060/kWh</span>
    </div>

    <div class="percentiles">
      <div class="pct-item" id="pct-25"><div class="pct-label">P25</div><div class="pct-value" id="p25-val">--</div></div>
      <div class="pct-item active" id="pct-50"><div class="pct-label">P50</div><div class="pct-value" id="p50-val">--</div></div>
      <div class="pct-item" id="pct-75"><div class="pct-label">P75</div><div class="pct-value" id="p75-val">--</div></div>
      <div class="pct-item" id="pct-90"><div class="pct-label">P90</div><div class="pct-value" id="p90-val">--</div></div>
    </div>

    <div class="chart-section">
      <div class="chart-title">矿机对比</div>
      <div id="chart-container"></div>
    </div>

    <div class="table-section">
      <div class="table-title">矿机详情</div>
      <table class="miner-table">
        <thead>
          <tr><th>矿机型号</th><th>算力</th><th>功耗</th><th>功耗比</th><th>关机价</th><th>状态</th></tr>
        </thead>
        <tbody id="miner-tbody"></tbody>
      </table>
    </div>

    <div class="footer">
      <p>数据: Binance · mempool.space | <a href="https://x.fish">Fish</a></p>
    </div>
  </div>

  <script>
    const BLOCK_REWARD = 3.125;

    const MINERS = [
      { model: 'Antminer S23 Hyd.', hashrate: 380, power: 5428 },
      { model: 'Whatsminer M70', hashrate: 310, power: 5270 },
      { model: 'Antminer S21+', hashrate: 250, power: 3750 },
      { model: 'Whatsminer M66S', hashrate: 298, power: 5067 },
      { model: 'Antminer S21 Hyd.', hashrate: 335, power: 5360 },
      { model: 'Antminer S21 Pro', hashrate: 234, power: 3510 },
      { model: 'Antminer S21', hashrate: 200, power: 3500 },
      { model: 'Whatsminer M63S', hashrate: 390, power: 7215 },
      { model: 'Whatsminer M60S', hashrate: 186, power: 3422 },
      { model: 'Antminer T21', hashrate: 190, power: 3610 },
      { model: 'Whatsminer M56S++', hashrate: 230, power: 5290 },
      { model: 'Antminer S19 XP Hyd.', hashrate: 255, power: 5304 },
      { model: 'Antminer S19 XP', hashrate: 140, power: 3010 },
      { model: 'Whatsminer M50S++', hashrate: 150, power: 3276 },
      { model: 'Whatsminer M50S+', hashrate: 140, power: 3080 },
      { model: 'Avalon A1466', hashrate: 150, power: 3350 },
      { model: 'Whatsminer M50', hashrate: 118, power: 3276 },
      { model: 'Antminer S19j Pro+', hashrate: 122, power: 3355 },
      { model: 'Antminer S19 Pro', hashrate: 110, power: 3250 },
      { model: 'Antminer S19j Pro', hashrate: 104, power: 3068 },
    ].filter(m => (m.power / m.hashrate) <= 29.5);

    let currentPrice = 0, currentDifficulty = 0;

    function calcShutdown(hr, pw, diff, elec) {
      const btcPerDay = (86400 * hr * 1e12 * BLOCK_REWARD) / (diff * Math.pow(2, 32));
      return (pw * 24 / 1000 * elec) / btcPerDay;
    }

    function pct(arr, p) {
      const s = [...arr].sort((a, b) => a - b);
      const i = (p / 100) * (s.length - 1);
      const lo = Math.floor(i), hi = Math.ceil(i);
      return lo === hi ? s[lo] : s[lo] + (s[hi] - s[lo]) * (i - lo);
    }

    function fmt(v) { return '$' + Math.round(v).toLocaleString(); }

    async function fetchData() {
      try {
        const [tRes, mRes] = await Promise.all([
          fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT'),
          fetch('https://mempool.space/api/v1/mining/hashrate/3d')
        ]);
        const t = await tRes.json();
        currentPrice = parseFloat(t.lastPrice);
        const chg = parseFloat(t.priceChangePercent);
        const m = await mRes.json();
        currentDifficulty = m.currentDifficulty;

        document.getElementById('btc-price').innerHTML =
          '$' + currentPrice.toLocaleString('en-US', {maximumFractionDigits:0}) +
          ' <span style="font-size:12px;color:' + (chg >= 0 ? 'var(--green)' : 'var(--red)') + '">' +
          (chg >= 0 ? '↑' : '↓') + Math.abs(chg).toFixed(2) + '%</span>';
        document.getElementById('hashrate').textContent = (m.currentHashrate / 1e18).toFixed(1) + ' EH/s';
        updateAll();
      } catch (e) { console.error(e); }
    }

    function updateAll() {
      const elec = parseFloat(document.getElementById('electricity').value);
      const data = MINERS.map(m => ({
        ...m,
        eff: (m.power / m.hashrate).toFixed(1),
        sp: calcShutdown(m.hashrate, m.power, currentDifficulty, elec)
      })).sort((a, b) => a.sp - b.sp);

      const sps = data.map(d => d.sp);
      const profitN = sps.filter(p => currentPrice > p).length;
      const p25 = pct(sps, 25), p50 = pct(sps, 50), p75 = pct(sps, 75), p90 = pct(sps, 90);

      document.getElementById('p25-val').textContent = fmt(p25);
      document.getElementById('p50-val').textContent = fmt(p50);
      document.getElementById('p75-val').textContent = fmt(p75);
      document.getElementById('p90-val').textContent = fmt(p90);
      document.getElementById('range').textContent = fmt(Math.min(...sps)) + ' ~ ' + fmt(Math.max(...sps));
      document.getElementById('profit-count').innerHTML = '<span class="profit">' + profitN + '</span>/' + data.length;

      // ahr999
      const days = Math.floor((Date.now() - new Date('2009-01-03').getTime()) / 86400000);
      const expPrice = Math.pow(10, 5.84 * Math.log10(days) - 17.01);
      const ahr = (currentPrice / (currentPrice * 0.92)) * (currentPrice / expPrice);
      const aEl = document.getElementById('ahr999');
      aEl.textContent = ahr.toFixed(2);
      aEl.style.color = ahr < 1.2 ? 'var(--green)' : ahr < 5 ? 'var(--gold)' : 'var(--red)';

      // 百分位高亮
      ['pct-25','pct-50','pct-75','pct-90'].forEach(id => document.getElementById(id).classList.remove('active'));
      if (currentPrice <= p25) document.getElementById('pct-25').classList.add('active');
      else if (currentPrice <= p50) document.getElementById('pct-50').classList.add('active');
      else if (currentPrice <= p75) document.getElementById('pct-75').classList.add('active');
      else document.getElementById('pct-90').classList.add('active');

      // === 图表：严格同一坐标系 ===
      const xCeil = Math.ceil(Math.max(currentPrice * 1.15, Math.max(...sps) * 1.1) / 30000) * 30000;
      const nSteps = xCeil / 30000;
      const cc = document.getElementById('chart-container');

      // 构建结构：每行 = 标签 + 条形（在同一个 tracks-area 容器内）
      // 价格线也在 tracks-area 内，用同样的百分比
      let rows = '';
      data.forEach(d => {
        const wPct = (d.sp / xCeil * 100).toFixed(4);
        const ok = currentPrice > d.sp;
        rows += '<div class="chart-row">' +
          '<div class="chart-label">' + d.model + '</div>' +
          '<div class="tracks-area">' +
            '<div class="track-bar ' + (ok ? 'profit' : 'loss') + '" style="width:' + wPct + '%"></div>' +
          '</div></div>';
      });

      // 价格线：放在一个独立行里，跨越整个条形区域
      const pricePct = (currentPrice / xCeil * 100).toFixed(4);

      // X 轴
      let xLabels = '';
      for (let i = 0; i <= nSteps; i++) {
        xLabels += '<span>$' + (30000 * i / 1000) + 'k</span>';
      }

      cc.innerHTML =
        '<div style="position:relative">' +
          // 所有条形行
          rows +
          // 价格竖线覆盖层 — 绝对定位，left 用同样的百分比坐标
          '<div style="position:absolute;top:0;bottom:0;left:0;right:0;pointer-events:none;">' +
            '<div style="position:absolute;top:0;bottom:0;left:140px;right:0;">' +
              '<div class="price-line-v" style="left:' + pricePct + '%">' +
                '<div class="price-line-tag">BTC ' + fmt(currentPrice) + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        // X 轴
        '<div class="x-axis-row">' +
          '<div class="x-axis-spacer"></div>' +
          '<div class="x-axis-track">' + xLabels + '</div>' +
        '</div>';

      // 表格
      document.getElementById('miner-tbody').innerHTML = data.map(d => {
        const ok = currentPrice > d.sp;
        return '<tr><td class="model">' + d.model + '</td><td>' + d.hashrate + ' TH/s</td><td>' +
          d.power + ' W</td><td>' + d.eff + ' W/TH</td><td class="shutdown ' + (ok?'profit':'loss') + '">' +
          fmt(d.sp) + '</td><td><span class="status-badge ' + (ok?'status-profit':'status-loss') + '">' +
          (ok?'盈利':'亏损') + '</span></td></tr>';
      }).join('');
    }

    document.getElementById('electricity').addEventListener('input', function() {
      const v = parseFloat(this.value).toFixed(3);
      document.getElementById('elec-value').textContent = '$' + v + '/kWh';
      document.getElementById('elec-display').textContent = '$' + v;
      if (currentPrice > 0 && currentDifficulty > 0) updateAll();
    });

    fetchData();
    setInterval(fetchData, 15000);
  </script>
</body>
</html>
